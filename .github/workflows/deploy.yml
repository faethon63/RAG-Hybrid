name: Deploy RAG-Hybrid

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 72.60.27.167
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/rag-hybrid

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Backend: install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Frontend: rebuild React app
            cd frontend-react
            npm ci --silent
            npm run build
            cd ..

            # Restart backend service
            pm2 restart rag-backend

            # Health check (wait for startup)
            sleep 5
            curl -sf http://localhost:8000/api/v1/health || echo "Health check failed"

            # Auto-index project KB documents (if any exist)
            for project_dir in /opt/rag-hybrid/config/project-kb/*/; do
              if [ -d "$project_dir/documents" ] && [ "$(ls -A "$project_dir/documents" 2>/dev/null)" ]; then
                project_name=$(basename "$project_dir")
                echo "Auto-indexing KB for project: $project_name"
                curl -sf -X POST "http://localhost:8000/api/v1/projects/$project_name/index" || echo "  Index failed for $project_name"
              fi
            done
